name: Metrics Alert Checks

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  check-dora-alerts:
    name: Check DORA Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify Configuration
        id: config
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_KEY" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::Supabase secrets not configured. Skipping metrics alert checks."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.config.outputs.configured == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        if: steps.config.outputs.configured == 'true'
        run: npm ci

      - name: Check Deployment Frequency
        if: steps.config.outputs.configured == 'true'
        id: deploy-freq
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_KEY
          );

          async function check() {
            // Get deployments this week
            const thisWeekStart = new Date();
            thisWeekStart.setDate(thisWeekStart.getDate() - 7);

            const { data: thisWeek } = await supabase
              .from('dora_metrics')
              .select('*')
              .eq('event_type', 'deployment')
              .gte('timestamp', thisWeekStart.toISOString());

            // Get deployments last week
            const lastWeekStart = new Date(thisWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);

            const { data: lastWeek } = await supabase
              .from('dora_metrics')
              .select('*')
              .eq('event_type', 'deployment')
              .gte('timestamp', lastWeekStart.toISOString())
              .lt('timestamp', thisWeekStart.toISOString());

            const thisWeekCount = thisWeek?.length || 0;
            const lastWeekCount = lastWeek?.length || 0;

            console.log(\`DEPLOY_THIS_WEEK=\${thisWeekCount}\`);
            console.log(\`DEPLOY_LAST_WEEK=\${lastWeekCount}\`);

            // Alert if >50% drop
            if (thisWeekCount < lastWeekCount * 0.5) {
              const dropPct = ((1 - thisWeekCount/lastWeekCount) * 100).toFixed(0);
              console.log(\`ALERT_DEPLOY_FREQ=Deployment frequency dropped \${dropPct}% (\${thisWeekCount} vs \${lastWeekCount})\`);
              console.log('ALERT_SEVERITY=MEDIUM');
            } else {
              console.log('ALERT_DEPLOY_FREQ=');
            }
          }

          check().catch(console.error);
          " >> $GITHUB_OUTPUT

      - name: Check Lead Time
        if: steps.config.outputs.configured == 'true'
        id: lead-time
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_KEY
          );

          async function check() {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            // Current lead time (7 days)
            const { data: recent } = await supabase
              .from('dora_metrics')
              .select('lead_time_hours')
              .gte('timestamp', sevenDaysAgo.toISOString())
              .not('lead_time_hours', 'is', null);

            // Baseline (30 days)
            const { data: baseline } = await supabase
              .from('dora_metrics')
              .select('lead_time_hours')
              .gte('timestamp', thirtyDaysAgo.toISOString())
              .not('lead_time_hours', 'is', null);

            const avgRecent = recent?.reduce((sum, r) => sum + r.lead_time_hours, 0) / (recent?.length || 1);
            const avgBaseline = baseline?.reduce((sum, r) => sum + r.lead_time_hours, 0) / (baseline?.length || 1);

            console.log(\`LEAD_TIME_CURRENT=\${avgRecent.toFixed(1)}\`);
            console.log(\`LEAD_TIME_BASELINE=\${avgBaseline.toFixed(1)}\`);

            // Alert if >2x baseline
            if (avgRecent > avgBaseline * 2) {
              const multiplier = (avgRecent / avgBaseline).toFixed(1);
              console.log(\`ALERT_LEAD_TIME=Lead time \${multiplier}x baseline (\${avgRecent.toFixed(1)}h vs \${avgBaseline.toFixed(1)}h)\`);
              console.log('ALERT_SEVERITY=HIGH');
            } else if (avgRecent > 48) {
              console.log(\`ALERT_LEAD_TIME=Lead time exceeds 48h threshold (\${avgRecent.toFixed(1)}h)\`);
              console.log('ALERT_SEVERITY=MEDIUM');
            } else {
              console.log('ALERT_LEAD_TIME=');
            }
          }

          check().catch(console.error);
          " >> $GITHUB_OUTPUT

      - name: Check Change Failure Rate
        if: steps.config.outputs.configured == 'true'
        id: cfr
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_KEY
          );

          async function check() {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const { data: deployments } = await supabase
              .from('dora_metrics')
              .select('deployment_failed')
              .in('event_type', ['deployment', 'push'])
              .gte('timestamp', sevenDaysAgo.toISOString());

            const totalDeployments = deployments?.length || 0;
            const failedDeployments = deployments?.filter(d => d.deployment_failed).length || 0;
            const cfr = totalDeployments > 0 ? (failedDeployments / totalDeployments * 100) : 0;

            console.log(\`CFR=\${cfr.toFixed(1)}\`);
            console.log(\`TOTAL_DEPLOYMENTS=\${totalDeployments}\`);
            console.log(\`FAILED_DEPLOYMENTS=\${failedDeployments}\`);

            // Alert if CFR >25%
            if (cfr > 25 && totalDeployments >= 5) {
              console.log(\`ALERT_CFR=Change failure rate at \${cfr.toFixed(1)}% (\${failedDeployments}/\${totalDeployments} deployments)\`);
              console.log('ALERT_SEVERITY=CRITICAL');
            } else if (cfr > 15) {
              console.log(\`ALERT_CFR=Change failure rate \${cfr.toFixed(1)}% exceeds Elite threshold (<15%)\`);
              console.log('ALERT_SEVERITY=MEDIUM');
            } else {
              console.log('ALERT_CFR=');
            }
          }

          check().catch(console.error);
          " >> $GITHUB_OUTPUT

      - name: Check MTTR
        if: steps.config.outputs.configured == 'true'
        id: mttr
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_KEY
          );

          async function check() {
            // Check for open critical incidents >1h
            const oneHourAgo = new Date();
            oneHourAgo.setHours(oneHourAgo.getHours() - 1);

            const { data: openIncidents } = await supabase
              .from('incidents')
              .select('*')
              .eq('status', 'open')
              .eq('severity', 'critical')
              .lt('created_at_github', oneHourAgo.toISOString());

            if (openIncidents && openIncidents.length > 0) {
              const incident = openIncidents[0];
              const openHours = ((Date.now() - new Date(incident.created_at_github)) / 3600000).toFixed(1);
              console.log(\`ALERT_MTTR=Critical incident #\${incident.issue_number} open \${openHours}h (target: <1h)\`);
              console.log('ALERT_SEVERITY=CRITICAL');
              return;
            }

            // Check average MTTR for resolved incidents
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const { data: resolved } = await supabase
              .from('incidents')
              .select('mttr_hours')
              .eq('status', 'closed')
              .gte('created_at_github', sevenDaysAgo.toISOString())
              .not('mttr_hours', 'is', null);

            const avgMTTR = resolved?.reduce((sum, r) => sum + r.mttr_hours, 0) / (resolved?.length || 1);

            console.log(\`AVG_MTTR=\${avgMTTR.toFixed(1)}\`);

            if (avgMTTR > 1) {
              console.log(\`ALERT_MTTR=Average MTTR \${avgMTTR.toFixed(1)}h exceeds 1h target\`);
              console.log('ALERT_SEVERITY=HIGH');
            } else {
              console.log('ALERT_MTTR=');
            }
          }

          check().catch(console.error);
          " >> $GITHUB_OUTPUT

      - name: Check Alert Cooldown
        if: steps.config.outputs.configured == 'true'
        id: cooldown
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node -e "
          const https = require('https');

          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_KEY;

          const alerts = [
            { type: 'deploy_freq', message: '${{ steps.deploy-freq.outputs.ALERT_DEPLOY_FREQ }}' },
            { type: 'lead_time', message: '${{ steps.lead-time.outputs.ALERT_LEAD_TIME }}' },
            { type: 'cfr', message: '${{ steps.cfr.outputs.ALERT_CFR }}' },
            { type: 'mttr', message: '${{ steps.mttr.outputs.ALERT_MTTR }}' }
          ].filter(a => a.message);

          async function checkCooldowns() {
            if (alerts.length === 0) {
              console.log('SEND_ALERTS=false');
              return;
            }

            const alertsToSend = [];
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

            for (const alert of alerts) {
              // Query last alert of this type
              const url = \`\${supabaseUrl}/rest/v1/alert_history?alert_type=eq.\${alert.type}&order=created_at.desc&limit=1\`;

              const lastAlert = await new Promise((resolve, reject) => {
                https.get(url, {
                  headers: {
                    'apikey': supabaseKey,
                    'Authorization': \`Bearer \${supabaseKey}\`
                  }
                }, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => resolve(JSON.parse(data)));
                }).on('error', reject);
              });

              // Check if cooldown expired (>1 hour since last alert)
              if (lastAlert.length === 0 || lastAlert[0].created_at < oneHourAgo) {
                alertsToSend.push(alert);
              } else {
                console.log(\`Cooldown active for \${alert.type} (last: \${lastAlert[0].created_at})\`);
              }
            }

            if (alertsToSend.length > 0) {
              console.log('SEND_ALERTS=true');
              console.log(\`ALERTS_TO_SEND=\${JSON.stringify(alertsToSend)}\`);
            } else {
              console.log('SEND_ALERTS=false');
              console.log('All alerts in cooldown period');
            }
          }

          checkCooldowns().catch(console.error);
          " >> $GITHUB_OUTPUT

      - name: Send Slack Alerts
        if: steps.config.outputs.configured == 'true' && steps.cooldown.outputs.SEND_ALERTS == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ALERTS=""

          if [ -n "${{ steps.deploy-freq.outputs.ALERT_DEPLOY_FREQ }}" ]; then
            ALERTS="$ALERTS\nâ€¢ âš ï¸ ${{ steps.deploy-freq.outputs.ALERT_DEPLOY_FREQ }}"
          fi

          if [ -n "${{ steps.lead-time.outputs.ALERT_LEAD_TIME }}" ]; then
            ALERTS="$ALERTS\nâ€¢ âš ï¸ ${{ steps.lead-time.outputs.ALERT_LEAD_TIME }}"
          fi

          if [ -n "${{ steps.cfr.outputs.ALERT_CFR }}" ]; then
            ALERTS="$ALERTS\nâ€¢ ðŸš¨ ${{ steps.cfr.outputs.ALERT_CFR }}"
          fi

          if [ -n "${{ steps.mttr.outputs.ALERT_MTTR }}" ]; then
            ALERTS="$ALERTS\nâ€¢ ðŸš¨ ${{ steps.mttr.outputs.ALERT_MTTR }}"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸ“Š Engineering Metrics Alerts\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$ALERTS\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View Dashboard\"
                      },
                      \"url\": \"https://roosevelt-ops.vercel.app\"
                    }
                  ]
                }
              ]
            }"

      - name: Log Alerts to Database
        if: steps.config.outputs.configured == 'true' && steps.cooldown.outputs.SEND_ALERTS == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          node -e "
          const https = require('https');

          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_KEY;

          const alerts = [
            { type: 'deploy_freq', message: '${{ steps.deploy-freq.outputs.ALERT_DEPLOY_FREQ }}', severity: 'MEDIUM' },
            { type: 'lead_time', message: '${{ steps.lead-time.outputs.ALERT_LEAD_TIME }}', severity: 'MEDIUM' },
            { type: 'cfr', message: '${{ steps.cfr.outputs.ALERT_CFR }}', severity: 'HIGH' },
            { type: 'mttr', message: '${{ steps.mttr.outputs.ALERT_MTTR }}', severity: 'HIGH' }
          ].filter(a => a.message);

          async function logAlerts() {
            for (const alert of alerts) {
              const data = JSON.stringify({
                alert_type: alert.type,
                alert_message: alert.message,
                alert_severity: alert.severity
              });

              const url = \`\${supabaseUrl}/rest/v1/alert_history\`;

              await new Promise((resolve, reject) => {
                const req = https.request(url, {
                  method: 'POST',
                  headers: {
                    'apikey': supabaseKey,
                    'Authorization': \`Bearer \${supabaseKey}\`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                  }
                }, (res) => {
                  res.on('data', () => {});
                  res.on('end', () => {
                    console.log(\`Logged \${alert.type} alert to database\`);
                    resolve();
                  });
                }).on('error', reject);

                req.write(data);
                req.end();
              });
            }
          }

          logAlerts().catch(console.error);
          "

      - name: Summary
        if: always()
        run: |
          echo "### Metrics Alert Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last checked:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### DORA Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.deploy-freq.outputs.ALERT_DEPLOY_FREQ }}" ]; then
            echo "| Deployment Frequency | âš ï¸ Alert | ${{ steps.deploy-freq.outputs.ALERT_DEPLOY_FREQ }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Deployment Frequency | âœ… OK | This week: ${{ steps.deploy-freq.outputs.DEPLOY_THIS_WEEK }}, Last week: ${{ steps.deploy-freq.outputs.DEPLOY_LAST_WEEK }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.lead-time.outputs.ALERT_LEAD_TIME }}" ]; then
            echo "| Lead Time | âš ï¸ Alert | ${{ steps.lead-time.outputs.ALERT_LEAD_TIME }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lead Time | âœ… OK | Current: ${{ steps.lead-time.outputs.LEAD_TIME_CURRENT }}h, Baseline: ${{ steps.lead-time.outputs.LEAD_TIME_BASELINE }}h |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.cfr.outputs.ALERT_CFR }}" ]; then
            echo "| Change Failure Rate | ðŸš¨ Alert | ${{ steps.cfr.outputs.ALERT_CFR }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Change Failure Rate | âœ… OK | ${{ steps.cfr.outputs.CFR }}% (${{ steps.cfr.outputs.FAILED_DEPLOYMENTS }}/${{ steps.cfr.outputs.TOTAL_DEPLOYMENTS }}) |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ steps.mttr.outputs.ALERT_MTTR }}" ]; then
            echo "| MTTR | ðŸš¨ Alert | ${{ steps.mttr.outputs.ALERT_MTTR }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MTTR | âœ… OK | Average: ${{ steps.mttr.outputs.AVG_MTTR }}h |" >> $GITHUB_STEP_SUMMARY
          fi
